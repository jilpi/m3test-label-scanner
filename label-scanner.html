<!doctype html>
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <title>Label Scanner</title>
        <link rel="stylesheet" href="label-scanner.css">
        <!-- <script src="qr-scanner/qr-scanner.umd.min.js"></script> -->
    </head>

    <body>
        <div>
            <b>Device has camera: </b>
            <span id="cam-has-camera"></span>
            <br>
            <b>Device has flash: </b>
            <span id="cam-has-flash"></span>
            <video id="qr-video" width="50%" hidden="true"></video>
        </div>
        <h1>Scan area:</h1>
        <scan-preview></scan-preview>
        <!-- <div>
            <button id="flash-toggle">ðŸ“¸ Flash: <span id="flash-state">off</span></button>
        </div> -->
        <b>Detected QR code: </b>
        <span id="cam-qr-result">None</span>
        <br>
        <b>Last detected at: </b>
        <span id="cam-qr-result-timestamp"></span>
        <br>
        <button id="start-button">Start</button>
        <button id="stop-button">Stop</button>
        <hr>

        <iframe id="label"></iframe>
        

        <script type="module">
            console.info("QR SCANNER - STARTS");

            import QrScanner from "./qr-scanner/qr-scanner.min.js";
            QrScanner.WORKER_PATH = './qr-scanner/qr-scanner-worker.min.js';
        
            const video = document.getElementById('qr-video');
            const camHasCamera = document.getElementById('cam-has-camera');
            const camHasFlash = document.getElementById('cam-has-flash');
            const flashToggle = document.getElementById('flash-toggle');
            const flashState = document.getElementById('flash-state');
            const camQrResult = document.getElementById('cam-qr-result');
            const camQrResultTimestamp = document.getElementById('cam-qr-result-timestamp');
            const fileQrResult = document.getElementById('file-qr-result');

            const labelIframe = document.getElementById('label');

            const REPRINT_INTERVAL = 5000;

            var latestResult = "";
            var latestResultTime = new Date().getTime();
        
            function printLabel(id){
                console.info(`PRINT LABEL ${id}`);

                // get attributes from label id

                labelIframe.src = 'generator/label-generator.html';                
            }

            function setResult(label, result) {

                // Print label ?
                // Yes if:
                //    - the scanned code is NEW
                //    - the scanned code is the same as last time, but wasn't scanned for > REPRINT_INTERVAL milliseconds
                if ((latestResult != result)
                        || (latestResult = result) && (Date.now() - latestResultTime > REPRINT_INTERVAL)) {

                    printLabel(result);
                }

                
                // Update latest result
                label.textContent = result;
                latestResult = result;
                
                // Update latest result time
                latestResultTime = Date.now();
                camQrResultTimestamp.textContent = latestResultTime.toString();

                // Change result color for REPRINT_INTERVAL milliseconds to indicate timeout
                label.style.color = 'red';
                clearTimeout(label.highlightTimeout);
                label.highlightTimeout = setTimeout(() => label.style.color = 'inherit', 5000);

            }
        
            function startScanner() {
                var result = scanner.start();
                if (result)
                    console.info("  - Scanner started successfully");
                else
                    console.error("  - Scanner failed to start !!");
            }

            // ######## Set listeners ##########
            // Scanner Start / Stop buttons
            document.getElementById('start-button').addEventListener('click', () => {
                startScanner();
            });        
            document.getElementById('stop-button').addEventListener('click', () => {
                scanner.stop();
            });

            // ####### Web Cam Scanning #######        
            // ### Initialisation ###
            console.info("- Instantiate scanner");
            QrScanner.hasCamera().then(hasCamera => camHasCamera.textContent = hasCamera);
        
            const scanner = new QrScanner(video, result => setResult(camQrResult, result), error => {
                // camQrResult.textContent = error;
                // camQrResult.style.color = 'inherit';
            });

            // for debugging
            window.scanner = scanner;


            // ### Flash Support ###
            scanner.start().then(() => {
                scanner.hasFlash().then(hasFlash => {
                    camHasFlash.textContent = hasFlash;
                    // if (hasFlash) {
                    //     flashToggle.style.display = 'inline-block';
                    //     flashToggle.addEventListener('click', () => {
                    //         scanner.toggleFlash().then(() => flashState.textContent = scanner.isFlashOn() ? 'on' : 'off');
                    //     });
                    // }
                });
            });


            // ### Display scan area preview ###
            console.info("- Display scan area");
            document.getElementsByTagName("scan-preview")[0].appendChild(scanner.$canvas);
            scanner.$canvas.height="50";
            scanner.$canvas.style.display = 'block';

            console.info("- Start scanner");
            startScanner();

            

        </script>
    </body>
</html>

