<!doctype html>
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <title>Label Scanner</title>
        <link rel="stylesheet" href="label-scanner.css">
        <script src="axios/dist/axios.min.js"></script>
        <script src="label-scanner.js"></script>
        <!-- Bootstrap -->
            <!-- Latest compiled and minified CSS -->
            <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
            <!-- jQuery library -->
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
            <!-- Popper JS -->
            <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
            <!-- Latest compiled JavaScript -->
            <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
            <meta name="viewport" content="width=device-width, initial-scale=1">
    </head>

    <body>
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-4">
                    <img src="img/logo-m3-sanitrade.png" class="img-fluid"  width="50%">
                </div>
                <div class="col-sm-4">
                    <div class="h1 text-center">
                        Accueil
                    </div>
                </div>
                <div class="col-sm-4">
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row">
                <div class="col">
                    <scan-preview></scan-preview>
                    <video id="qr-video" width="50%" hidden="true"></video>
                </div>
                <div class="col">
                    <div class="login">Login</div>
                    Caméra détectée:<span id="cam-has-camera"></span><br/>
                    Dernière lecture: <span id="cam-qr-result-timestamp"></span><br/>
                    QR Code:<input type="text" class="form-control" id="cam-qr-result">
                    <button class="button-primary" id="btn-check-qrcode">Check</button>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <iframe id="label"></iframe>
                    <br/>
                    <input type="checkbox" id="autoprint-toggle"> Enable Auto Print?
                </div>
                <div class="col">
                </div>
            </div>
        </div>

        <script type="module">
            console.info("QR SCANNER - STARTS");

            import QrScanner from "./qr-scanner/qr-scanner.min.js";
            QrScanner.WORKER_PATH = './qr-scanner/qr-scanner-worker.min.js';
            
            // const REST_API_URL="https://my-json-server.typicode.com/jilpi/m3test-label-scanner";
            // const REST_API_REQUEST_HEADERS={
            //     'X-Token': 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx', 
            //     'Content-Type': 'application/json'
            // };

            const REST_API_URL="https://m3-test.ch/api/";
            const REST_API_REQUEST_HEADERS={
                'Content-Type': 'application/json',
                'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjp7ImlkIjozLCJlbWFpbCI6ImotbC5waWNhcmRAbS0zLmNvbSIsInVzZXJuYW1lIjpudWxsLCJmaXJzdG5hbWUiOm51bGwsImxhc3RuYW1lIjpudWxsLCJjb3VudHJ5X2NvZGUiOm51bGwsIm1vYmlsZSI6bnVsbCwiYmlydGhkYXRlIjpudWxsLCJnZW5kZXIiOm51bGwsImNvbmZpcm1lZCI6dHJ1ZSwicm9sZSI6eyJsYWJlbCI6IkFkbWluIn19LCJpYXQiOjE2MDUxMDUyMzIsImV4cCI6MTYwNTE5MTYzMn0.ZBj0V1ExNP9vuNIdqsQNsnCVLSLdQMCIqur982T3ztA'
            };


            const video = document.getElementById('qr-video');
            const camHasCamera = document.getElementById('cam-has-camera');
            const camQrResult = document.getElementById('cam-qr-result');
            const camQrResultTimestamp = document.getElementById('cam-qr-result-timestamp');
            const fileQrResult = document.getElementById('file-qr-result');
            const autoprintToggle = document.getElementById('autoprint-toggle');

            const labelIframe = document.getElementById('label');

            const REPRINT_INTERVAL = 5000;

            var latestResult = "";
            var latestResultTime = new Date().getTime();
        
            function renameKey(o, old_key, new_key){
                if (old_key !== new_key) {
                    Object.defineProperty(o, new_key,
                       Object.getOwnPropertyDescriptor(o, old_key));
                    delete o[old_key];
                }
            }

            async function getBookingDataFromAPI(id){
                // API request
                var strEndPoint = REST_API_URL + `test/info?code=${id}`;
                var data = {};

                console.info(`  - API call at: ${strEndPoint}`);
                await axios.get(strEndPoint, { headers: REST_API_REQUEST_HEADERS })
                    // Handle a successful response from the server
                    .then(
                        function (response) {
                            // Getting a data object from response that contains the necessary data from the server
                            data = response.data;
//                            renameKey(data, 'id', 'code');
                        }
                    )
                    // Catch and print errors if any
                    .catch(function(error){
                            console.error('API Call', error)
                        }
                    );
                
                var filtered_data;
                
                return _.pick(data, );
            }

            async function printLabel(id){

                // get attributes from API / booking id
                console.info(`- API Call for ${id}`);
                const bookingData = await getBookingDataFromAPI(id);
                console.log('  - Data returned:', bookingData);

                if (autoprintToggle.checked){
                    bookingData.autoprint="";
                    console.info('  - Autoprint enabled')
                }



                console.info(`- Generate label ${id}`);
                const baseUrl = document.URL.substr(0,document.URL.lastIndexOf('/'));
                const labelUrl = new URL(baseUrl + '/generator/label-generator.html');
                labelUrl.search = new URLSearchParams(bookingData);
                console.info(`  - Label URL: ${labelUrl.toString()}`);
                labelIframe.src = labelUrl;
            }

            function setResult(result) {
                // Get new label?
                // Yes if:
                //    - the scanned code is NEW
                //    - the scanned code is the same as last time, but wasn't scanned for > REPRINT_INTERVAL milliseconds
                if ((latestResult != result)
                        || (latestResult = result) && (Date.now() - latestResultTime > REPRINT_INTERVAL)) {

                    printLabel(result);
                }

                // Update latest result
                camQrResult.value = result;
                latestResult = result;
                
                // Update latest result time
                latestResultTime = Date.now();
                camQrResultTimestamp.textContent = Date();

                // Change result color for REPRINT_INTERVAL milliseconds to indicate timeout
                label.style.color = 'red';
                clearTimeout(label.highlightTimeout);
                label.highlightTimeout = setTimeout(() => label.style.color = 'inherit', 5000);

            }
        
            // ####### Web Cam Scanning #######        
            // ### Initialisation ###
            console.info("- Instantiate scanner");
            QrScanner.hasCamera().then(
                function(hasCamera) {
                    console.info(`  - Camera${hasCamera?"":" not"} found`);
                    camHasCamera.textContent = hasCamera ? "✅" : "❌"
                }
            );
        
        
            const scanner = new QrScanner(video, result => setResult(result), error => {
                // camQrResult.textContent = error;
                // camQrResult.style.color = 'inherit';
            });

            // for debugging
            window.scanner = scanner;

            function startScanner() {
                var result = scanner.start();
                if (result)
                    console.info("  - Scanner started successfully");
                else
                    console.error("  - Scanner failed to start !!");
            }



            // ### Display scan area preview ###
            console.info("- Display scan area");
            document.getElementsByTagName("scan-preview")[0].appendChild(scanner.$canvas);
            scanner.$canvas.height="50";
            scanner.$canvas.style.display = 'block';

            console.info("- Start scanner");
            startScanner();

            // ### Set on clicks ###
            document.getElementById("btn-check-qrcode").onclick = function(){
                console.info("- Retrieving data for booking ID" + camQrResult.value)
                setResult(camQrResult.value);                
            }

        </script>
    </body>
</html>
